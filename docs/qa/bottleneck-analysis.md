# Ent-DNS ç“¶é¢ˆåˆ†ææŠ¥å‘Šï¼ˆä¿®å¤åæ›´æ–°ç‰ˆï¼‰

**åˆ†ææ—¥æœŸ**: 2026-02-20
**åˆ†ææ‰§è¡Œäºº**: QA Agent (James Bach)
**æµ‹è¯•ç‰ˆæœ¬**: v0.1.0 (commit e40662c)
**å‚è€ƒæ–‡æ¡£**: docs/qa/performance-baseline.md, docs/qa/dns-id-fix-validation-report.md

---

## æ‰§è¡Œæ‘˜è¦

åŸºäºæ€§èƒ½åŸºçº¿æµ‹è¯•ç»“æœï¼Œæœ¬æŠ¥å‘Šæ·±å…¥åˆ†æäº† Ent-DNS å½“å‰ç‰ˆæœ¬çš„ 4 ä¸ªä¸»è¦æ€§èƒ½ç“¶é¢ˆã€‚å…¶ä¸­ï¼Œ**DNS ID ä¸åŒ¹é…é—®é¢˜ï¼ˆP0ï¼‰å·²å®Œå…¨ä¿®å¤**ï¼ŒQPS ä» ~33 æå‡è‡³ 60,000-70,000ï¼Œé”™è¯¯ç‡é™è‡³ 0.00%ã€‚

### ç“¶é¢ˆä¼˜å…ˆçº§æ¦‚è§ˆï¼ˆä¿®å¤åï¼‰

| ç“¶é¢ˆ | ä¸¥é‡æ€§ | æ€§èƒ½å½±å“ | ä¿®å¤çŠ¶æ€ | ä¿®å¤ä¼˜å…ˆçº§ | é¢„è®¡å·¥ä½œé‡ |
|------|--------|----------|----------|------------|------------|
| DNS ID ä¸åŒ¹é… | **Critical** | 97-98% QPS æŸå¤± | âœ… å·²ä¿®å¤ | - | - |
| æ•°æ®åº“å¿«é€Ÿå¢é•¿ | High | 65GB/24h é¢„ä¼° | âš ï¸ å¾…ä¼˜åŒ– | **P1** | 0.5 å¤© |
| WAL æ–‡ä»¶å¢é•¿ | Medium | 5MB/5min | âš ï¸ å¾…ä¼˜åŒ– | **P2** | 0.5 å¤© |
| é«˜ QPS å»¶è¿Ÿ | Medium | P99: 1.87s | âš ï¸ å¾…ä¼˜åŒ– | **P2** | 1 å¤© |
| Metrics è®¤è¯ | Low | ç›‘æ§é›†æˆå›°éš¾ | ğŸ“Š å¾…ä¼˜åŒ– | **P3** | 0.25 å¤© |

---

## ç“¶é¢ˆ 1: DNS ID ä¸åŒ¹é…ï¼ˆCriticalï¼‰- âœ… å·²ä¿®å¤

### é—®é¢˜æè¿°

åœ¨é«˜å¹¶å‘ DNS æŸ¥è¯¢åœºæ™¯ä¸‹ï¼ŒDNS æœåŠ¡å™¨çš„å®é™… QPS ç¨³å®šåœ¨ ~33ï¼Œè¿œä½äºç›®æ ‡çš„ 100-2000 QPSã€‚åŒæ—¶ï¼Œdnsperf æŠ¥å‘Šå¤§é‡ `Unexpected IDs` å’Œ `Query timed out` é”™è¯¯ã€‚

### ä¿®å¤å‰åå¯¹æ¯”

| æŒ‡æ ‡ | ä¿®å¤å‰ | ä¿®å¤å | æå‡ |
|------|--------|--------|------|
| **å®é™… QPS** | 33 | 68,884 | **2086x** |
| **å®Œæˆç‡** | 7-62% | **100%** | +100% |
| **é”™è¯¯ç‡** | 37-92% | **0.00%** | -100% |

### æµ‹è¯•æ•°æ®ï¼ˆä¿®å¤åï¼‰

| ç›®æ ‡ QPS | å‘é€æŸ¥è¯¢ | å®ŒæˆæŸ¥è¯¢ | å®Œæˆç‡ | å®é™… QPS | é”™è¯¯ç‡ |
|----------|----------|----------|--------|----------|--------|
| 100      | 2,054,258 | 2,054,258 | **100.00%** | 68,472 | **0.00%** |
| 500      | 2,114,907 | 2,114,907 | **100.00%** | 70,474 | **0.00%** |
| 1000     | 2,081,955 | 2,081,955 | **100.00%** | 69,365 | **0.00%** |
| 2000     | 1,958,459 | 1,958,459 | **100.00%** | 65,195 | **0.00%** |
| 5000     | 1,944,085 | 1,941,831 | 99.88% | 64,572 | 0.12% |
| 10000    | 2,080,782 | 2,080,782 | **100.00%** | 69,044 | **0.00%** |

**å…³é”®è§‚å¯Ÿ**:
- âœ… æ‰€æœ‰ QPS çº§åˆ«éƒ½è¾¾åˆ° 99.88-100% å®Œæˆç‡
- âœ… æ—  "Unexpected IDs" é”™è¯¯ï¼ˆ5000 QPS æ—¶ 0.12% æ˜¯è¶…æ—¶ï¼‰
- âœ… ç³»ç»Ÿå¯ä»¥ç¨³å®šå¤„ç† 60,000-70,000 QPS

### ä¿®å¤éªŒè¯

**æµ‹è¯•æ–¹æ³•**:
1. æ‰§è¡Œ 6 ä¸ª QPS çº§åˆ«çš„æµ‹è¯•ï¼ˆ100, 500, 1000, 2000, 5000, 10000ï¼‰
2. æ¯çº§æµ‹è¯• 30 ç§’
3. éªŒè¯å®Œæˆç‡ >99%
4. éªŒè¯é”™è¯¯ç‡ <0.2%

**éªŒè¯ç»“æœ**:
- âœ… å®é™… QPS â‰¥ 90% ç›®æ ‡ QPSï¼ˆå®é™…è¿œè¶…ç›®æ ‡ï¼‰
- âœ… é”™è¯¯ç‡ <0.2%ï¼ˆå®é™… 0.00-0.12%ï¼‰
- âœ… æ—  "Unexpected IDs" é”™è¯¯
- âœ… 5 åˆ†é’Ÿç¨³å®šæ€§æµ‹è¯• 100% å®Œæˆ

**é€šè¿‡æ ‡å‡†**: âœ… å…¨éƒ¨é€šè¿‡

### ä»£ç åˆ†æ

#### DNS å“åº” ID è®¾ç½®é€»è¾‘

**æ–‡ä»¶**: `src/dns/handler.rs`

```rust
pub async fn handle(&self, data: Vec<u8>, client_ip: String) -> Result<Vec<u8>> {
    let request = Message::from_vec(&data)?;
    // ... å¤„ç†é€»è¾‘ ...
    let mut response = Message::new();
    response.set_id(request.id());  // âœ“ æ­£ç¡®ä½¿ç”¨è¯·æ±‚ ID
    response.set_message_type(MessageType::Response);
    // ...
    Ok(response.to_vec()?)
}
```

**Rewrite å“åº”**:
```rust
fn rewrite_response(&self, request: &Message, answer: &str, qtype: RecordType) -> Result<Vec<u8>> {
    // ...
    let mut response = Message::new();
    response.set_id(request.id());  // âœ“ æ­£ç¡®ä½¿ç”¨è¯·æ±‚ ID
    // ...
    Ok(response.to_vec()?)
}
```

**Resolver å“åº”**:
```rust
// src/dns/resolver.rs
pub async fn resolve(&self, domain: &str, qtype: RecordType, request: &Message) -> Result<(Vec<u8>, Option<u32>)> {
    let mut response = Message::new();
    response.set_id(request.id());  // âœ“ æ­£ç¡®ä½¿ç”¨è¯·æ±‚ ID
    // ...
    Ok((response.to_vec()?, min_ttl))
}
```

**ç»“è®º**: ä»£ç å±‚é¢ ID è®¾ç½®æ˜¯æ­£ç¡®çš„ã€‚

### æ ¹æœ¬åŸå› åˆ†æ

#### å‡è®¾ 1: hickory-resolver å†…éƒ¨é—®é¢˜ï¼ˆæœ€å¯èƒ½ï¼‰

**è¯æ®**:
- Ent-DNS ä½¿ç”¨ `hickory-resolver` çš„ `TokioAsyncResolver`
- è¯¥åº“å†…éƒ¨å¯èƒ½ä½¿ç”¨å…±äº«çš„ UDP socket æˆ–æŸ¥è¯¢ ID ç”Ÿæˆå™¨
- é«˜å¹¶å‘åœºæ™¯ä¸‹å¯èƒ½å­˜åœ¨ ID å†²çª

**éªŒè¯æ–¹æ³•**:
1. å¯ç”¨ DEBUG æ—¥å¿—ï¼Œè®°å½•æ¯ä¸ªè¯·æ±‚/å“åº”çš„ ID
2. æ£€æŸ¥æ˜¯å¦å­˜åœ¨ ID é‡å¤æˆ–é”™ä½
3. å°è¯•ç¦ç”¨ DNSSEC å’Œç¼“å­˜ï¼Œéš”ç¦»é—®é¢˜

**ä¿®å¤æ–¹æ¡ˆ**:
```rust
// æ–¹æ¡ˆ 1: å®ç°è‡ªå·±çš„ DNS ID ç”Ÿæˆå™¨ï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰
use std::sync::atomic::{AtomicU16, Ordering};

static DNS_ID_COUNTER: AtomicU16 = AtomicU16::new(1);

fn generate_dns_id() -> u16 {
    DNS_ID_COUNTER.fetch_add(1, Ordering::SeqCst)
}

// åœ¨ handle() ä¸­è¦†ç›– ID
let original_id = request.id();
let request_id = generate_dns_id();
// ä¿å­˜æ˜ å°„ï¼šoriginal_id -> request_idï¼Œå“åº”æ—¶è¿˜åŸ
```

```rust
// æ–¹æ¡ˆ 2: ä½¿ç”¨ç‹¬ç«‹çš„ UDP socket per worker
// é¿å…å¤šä¸ª worker å…±äº« socket å¯¼è‡´çš„ ID å†²çª
```

```rust
// æ–¹æ¡ˆ 3: åˆ‡æ¢åˆ° trust-dns æˆ–å…¶ä»–åº“
// å¦‚æœ hickory-resolver ç¡®å®æœ‰ bugï¼Œéœ€è¦æ›´æ¢åº“
```

#### å‡è®¾ 2: UDP æ•°æ®åŒ…ä¹±åº

**è¯æ®**:
- UDP æ˜¯æ— è¿æ¥åè®®ï¼Œæ•°æ®åŒ…å¯èƒ½ä¹±åºåˆ°è¾¾
- dnsperf å¯èƒ½å‘é€æŸ¥è¯¢é€Ÿåº¦è¶…è¿‡æœåŠ¡å™¨å¤„ç†èƒ½åŠ›

**éªŒè¯æ–¹æ³•**:
- ä½¿ç”¨ TCP DNS æµ‹è¯•ï¼ˆdnsperf æ”¯æŒ `-T` å‚æ•°ï¼‰
- å¯¹æ¯” TCP å’Œ UDP çš„é”™è¯¯ç‡

**ä¿®å¤æ–¹æ¡ˆ**:
- ä½¿ç”¨ TCP é•¿è¿æ¥å¤„ç† DNS æŸ¥è¯¢
- å®ç° DNS over TCP (RFC 7766)

#### å‡è®¾ 3: Message::from_vec() ç«äº‰æ¡ä»¶

**è¯æ®**:
- `Message::from_vec()` åœ¨é«˜å¹¶å‘ä¸‹å¯èƒ½æœ‰é—®é¢˜
- `hickory-proto` åº“çš„ bug

**éªŒè¯æ–¹æ³•**:
- æ·»åŠ æ—¥å¿—è®°å½• `request.id()` çš„å€¼
- æ£€æŸ¥æ˜¯å¦æœ‰ ID å¼‚å¸¸ï¼ˆ0ã€é‡å¤ç­‰ï¼‰

**ä¿®å¤æ–¹æ¡ˆ**:
- å‡çº§ `hickory-proto` åˆ°æœ€æ–°ç‰ˆæœ¬
- æˆ–æäº¤ bug report åˆ° hickory-resolver

### æ€§èƒ½å½±å“è¯„ä¼°

**å½“å‰çŠ¶æ€**:
- **ç†è®º QPS**: 100-2000ï¼ˆç›®æ ‡ï¼‰
- **å®é™… QPS**: ~33
- **æ€§èƒ½æŸå¤±**: **97-98%**

**ä¿®å¤åé¢„æœŸ**:
- **å®é™… QPS**: 100-2000ï¼ˆä¸ç›®æ ‡åŒ¹é…ï¼‰
- **é”™è¯¯ç‡**: <1%
- **P95 å»¶è¿Ÿ**: <10ms

### ä¿®å¤ä¼˜å…ˆçº§: **P0ï¼ˆç´§æ€¥ï¼‰**

**åŸå› **:
- ä¸¥é‡å½±å“åŠŸèƒ½ï¼ˆDNS æŸ¥è¯¢å¤±è´¥ç‡é«˜ï¼‰
- ä¸å¯éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
- å½±å“ç”¨æˆ·ä½“éªŒ

**ä¿®å¤è®¡åˆ’**:
1. **Day 1**: å¯ç”¨è°ƒè¯•æ—¥å¿—ï¼ŒéªŒè¯å‡è®¾ 1
2. **Day 2**: å®ç°ä¿®å¤æ–¹æ¡ˆ 1ï¼ˆè‡ªå®šä¹‰ ID ç”Ÿæˆå™¨ï¼‰
3. **Day 3**: æµ‹è¯•éªŒè¯ï¼Œç¡®ä¿ QPS æ¢å¤æ­£å¸¸

**å›é€€è®¡åˆ’**:
- å¦‚æœæ–¹æ¡ˆ 1 ä¸å¥æ•ˆï¼Œå°è¯•æ–¹æ¡ˆ 2ï¼ˆTCPï¼‰
- å¦‚æœæ–¹æ¡ˆ 2 ä¹Ÿä¸å¥æ•ˆï¼Œè€ƒè™‘æ›´æ¢ DNS åº“

**é€šè¿‡æ ‡å‡†**: âœ… å…¨éƒ¨é€šè¿‡

---

## ç“¶é¢ˆ 2: æ•°æ®åº“æ–‡ä»¶å¿«é€Ÿå¢é•¿ï¼ˆHighï¼‰

### é—®é¢˜æè¿°

æ•°æ®åº“æ–‡ä»¶åœ¨é«˜ QPS åœºæ™¯ä¸‹å¿«é€Ÿå¢é•¿ï¼Œ5 åˆ†é’Ÿå†…ä» 0 å¢é•¿è‡³ 227MBã€‚é¢„ä¼° 24 å°æ—¶å¯èƒ½å¢é•¿è‡³ 65GBã€‚

### æµ‹è¯•æ•°æ®ï¼ˆä¿®å¤åï¼‰

```
æµ‹è¯•å‰:
  æ•°æ®åº“å¤§å°: 0 MB
  WAL æ–‡ä»¶: 0 MB

5 åˆ†é’Ÿæµ‹è¯•å (1000 QPS):
  æ•°æ®åº“å¤§å°: 227 MB
  WAL æ–‡ä»¶: 5 MB
  å†…å­˜ (RSS): 40.8 MB

æ•°æ®åº“å¢é•¿ç‡:
  å¢é•¿é€Ÿç‡: 45.4 MB/min
  é¢„ä¼° 1 å°æ—¶: 2.7 GB
  é¢„ä¼° 24 å°æ—¶: 65.4 GB
```

### æ ¹æœ¬åŸå› 

**Query Log è®°å½•**:
- æ¯æ¬¡æŸ¥è¯¢éƒ½å†™å…¥ `query_log` è¡¨
- æ²¡æœ‰è‡ªåŠ¨è½®è½¬æˆ–æ¸…ç†æœºåˆ¶
- åŒ…å«å­—æ®µ: domain, qtype, client_ip, response, blocked, upstream

**ç¤ºä¾‹æ•°æ®é‡**:
- 20M æŸ¥è¯¢ â†’ 227MB
- æ¯æ¡è®°å½•: ~11.4KB
- åŒ…å«å¤§é‡é‡å¤çš„ client_ipã€response å­—æ®µ

### æ€§èƒ½å½±å“

**å½“å‰å½±å“**:
- ç£ç›˜ç©ºé—´æ¶ˆè€—è¿‡å¿«
- é•¿æœŸè¿è¡Œå¯èƒ½è€—å°½ç£ç›˜ç©ºé—´
- æŸ¥è¯¢æ—¥å¿—æ€§èƒ½ä¸‹é™

**é•¿æœŸå½±å“**:
- 24 å°æ—¶: 65 GB
- 1 å‘¨: 458 GB
- éœ€è¦å®šæœŸæ¸…ç†æˆ–è½®è½¬

### ä¿®å¤æ–¹æ¡ˆ

#### æ–¹æ¡ˆ 1: æŸ¥è¯¢æ—¥å¿—è½®è½¬ï¼ˆæ¨èï¼‰

```rust
// åœ¨ QueryLogWriter ä¸­æ·»åŠ å®šæ—¶æ¸…ç†ä»»åŠ¡
async fn log_rotation_task(pool: DbPool) {
    let mut interval = tokio::time::interval(Duration::from_secs(86400)); // æ¯å¤©
    loop {
        interval.tick().await;
        if let Ok(conn) = pool.acquire().await {
            // åˆ é™¤ 7 å¤©å‰çš„æ—¥å¿—
            let _ = conn.execute(
                "DELETE FROM query_log WHERE time < datetime('now', '-7 days');"
            );
        }
    }
}
```

**é…ç½®é€‰é¡¹**:
```toml
[dns.query_log]
enabled = true              # æ˜¯å¦å¯ç”¨
retention_days = 7          # ä¿ç•™å¤©æ•°
rotation_interval = 86400   # è½®è½¬é—´éš”ï¼ˆç§’ï¼‰
```

#### æ–¹æ¡ˆ 2: ç¦ç”¨æŸ¥è¯¢æ—¥å¿—

```toml
[dns.query_log]
enabled = false
```

**æƒè¡¡**:
- âœ… é›¶ç£ç›˜å¼€é”€
- âŒ æ— æ³•å®¡è®¡æŸ¥è¯¢å†å²
- âŒ æ— æ³•åˆ†æ DNS ä½¿ç”¨æƒ…å†µ

#### æ–¹æ¡ˆ 3: é‡‡æ ·è®°å½•

```rust
// åªè®°å½• 10% çš„æŸ¥è¯¢
if rand::random::<f64>() < 0.1 {
    // è®°å½•æŸ¥è¯¢
}
```

**é…ç½®é€‰é¡¹**:
```toml
[dns.query_log]
enabled = true
sampling_rate = 0.1        # é‡‡æ ·ç‡ 10%
```

**æƒè¡¡**:
- âœ… å‡å°‘ç£ç›˜å¼€é”€ 90%
- âœ… ä¿ç•™éƒ¨åˆ†å®¡è®¡èƒ½åŠ›
- âŒ æ•°æ®ä¸å®Œæ•´

### ä¿®å¤ä¼˜å…ˆçº§: **P1ï¼ˆé«˜ï¼‰**

**åŸå› **:
- å½±å“é•¿æœŸç¨³å®šæ€§
- ç£ç›˜ç©ºé—´å¯èƒ½è¶…å‡ºé¢„æœŸ
- ä¸Šçº¿å‰å¿…é¡»è§£å†³

**ä¿®å¤è®¡åˆ’**:
1. **Day 1**: å®ç°æ–¹æ¡ˆ 1ï¼ˆæ—¥å¿—è½®è½¬ï¼‰
2. **Day 2**: æ·»åŠ é…ç½®é€‰é¡¹ï¼ˆç¦ç”¨/é‡‡æ ·ï¼‰
3. **Day 3**: æµ‹è¯•éªŒè¯ 24 å°æ—¶ç¨³å®šæ€§

**é¢„æœŸæ•ˆæœ**:
- **æ•°æ®åº“å¤§å°**: <1 GBï¼ˆä¿ç•™ 7 å¤©ï¼‰
- **å¢é•¿ç‡**: å¹³ç¨³ï¼ˆå®šæœŸæ¸…ç†ï¼‰

---

## ç“¶é¢ˆ 3: WAL æ–‡ä»¶å¢é•¿ï¼ˆMediumï¼‰
- **å¹³å‡å¢é•¿**: ~4.9 KB/ç§’

### æ ¹æœ¬åŸå› åˆ†æ

#### SQLite WAL æ¨¡å¼

WAL æ¨¡å¼ä¸‹ï¼Œæ‰€æœ‰å†™å…¥å…ˆå†™å…¥ WAL æ–‡ä»¶ï¼Œå®šæœŸ checkpoint åˆ°ä¸»æ•°æ®åº“ã€‚é»˜è®¤ checkpoint ç­–ç•¥å¯èƒ½ä¸é€‚åˆé«˜å†™å…¥åœºæ™¯ã€‚

**å½“å‰é…ç½®**ï¼ˆæ¨æµ‹ï¼‰:
```sql
PRAGMA journal_mode = WAL;  -- WAL æ¨¡å¼
PRAGMA wal_autocheckpoint = 1000;  -- é»˜è®¤å€¼ï¼ˆå¯èƒ½æœªè®¾ç½®ï¼‰
```

#### QueryLogWriter å®ç°

**æ–‡ä»¶**: `src/db/query_log_writer.rs`

**æ‰¹é‡å†™å…¥é€»è¾‘**:
```rust
// æ¯ 100 æ¡æˆ– 1 ç§’å†™å…¥ä¸€æ¬¡
const BATCH_SIZE: usize = 100;
const FLUSH_INTERVAL: Duration = Duration::from_secs(1);
```

**é—®é¢˜**:
- æ‰¹é‡å¤§å° 100 æ¡å¯èƒ½è¿‡å°
- æ²¡æœ‰ä¸»åŠ¨è§¦å‘ WAL checkpoint
- WAL æ–‡ä»¶å¯èƒ½æŒç»­å¢é•¿

### æ€§èƒ½å½±å“è¯„ä¼°

**å½“å‰çŠ¶æ€**:
- **WAL æ–‡ä»¶**: 4.4 MBï¼ˆ15 åˆ†é’Ÿï¼‰
- **WAL/DB æ¯”ä¾‹**: 19%
- **å¢é•¿é€Ÿç‡**: ~4.9 KB/ç§’

**æ½œåœ¨å½±å“**:
1. **ç£ç›˜ I/O**: WAL æ–‡ä»¶è¿‡å¤§ä¼šå¢åŠ éšæœºè¯»å†™
2. **Checkpoint é˜»å¡**: å¤§ WAL æ–‡ä»¶å¯¼è‡´ checkpoint æ“ä½œé˜»å¡æ•°æ®åº“
3. **æŸ¥è¯¢æ—¥å¿—æ€§èƒ½**: æ‰¹é‡å†™å…¥æ€§èƒ½ä¸‹é™

**é•¿æœŸå½±å“**ï¼ˆ24 å°æ—¶ï¼‰:
- **é¢„ä¼° WAL å¤§å°**: 4.4 MB Ã— (24Ã—60/15) â‰ˆ 422 MB
- **ç£ç›˜ç©ºé—´**: å¯èƒ½è¶…å‡ºé¢„æœŸ

### ä¿®å¤æ–¹æ¡ˆ

#### æ–¹æ¡ˆ 1: è°ƒæ•´ SQLite PRAGMA

```rust
// åœ¨æ•°æ®åº“è¿æ¥æ—¶è®¾ç½®
conn.execute("PRAGMA wal_autocheckpoint = 1000;")?;  // æ¯ 1000 é¡µ checkpoint
conn.execute("PRAGMA synchronous = NORMAL;")?;  // é™ä½åŒæ­¥å¼€é”€
conn.execute("PRAGMA cache_size = -64000;")?;  // 64MB ç¼“å­˜
```

#### æ–¹æ¡ˆ 2: å®šæœŸæ‰‹åŠ¨ checkpoint

```rust
// åœ¨ QueryLogWriter ä¸­æ·»åŠ å®šæœŸ checkpoint
use tokio::time::{sleep, Duration};

async fn periodic_checkpoint(pool: DbPool) {
    let mut interval = interval(Duration::from_secs(300));  // æ¯ 5 åˆ†é’Ÿ
    loop {
        interval.tick().await;
        if let Ok(conn) = pool.acquire().await {
            let _ = conn.execute("PRAGMA wal_checkpoint(TRUNCATE);");
        }
    }
}
```

#### æ–¹æ¡ˆ 3: è°ƒæ•´æ‰¹é‡å†™å…¥å‚æ•°

```rust
// å¢åŠ æ‰¹é‡å¤§å°å’Œé—´éš”
const BATCH_SIZE: usize = 500;  // 100 -> 500
const FLUSH_INTERVAL: Duration = Duration::from_secs(5);  // 1s -> 5s
```

**æƒè¡¡**:
- âœ… å‡å°‘ WAL checkpoint é¢‘ç‡
- âœ… é™ä½ç£ç›˜ I/O
- âŒ å¢åŠ æŸ¥è¯¢æ—¥å¿—å»¶è¿Ÿï¼ˆ5 ç§’ï¼‰
- âŒ å´©æºƒæ—¶å¯èƒ½ä¸¢å¤±æ›´å¤šæ•°æ®

### ä¿®å¤ä¼˜å…ˆçº§: **P1ï¼ˆé«˜ï¼‰**

**åŸå› **:
- å¯èƒ½å½±å“é•¿æœŸç¨³å®šæ€§
- ç£ç›˜ç©ºé—´å¯èƒ½è¶…å‡ºé¢„æœŸ
- å½±å“æŸ¥è¯¢æ—¥å¿—æ€§èƒ½

**ä¿®å¤è®¡åˆ’**:
1. **Day 1**: å®ç°æ–¹æ¡ˆ 1ï¼ˆè°ƒæ•´ PRAGMAï¼‰
2. **Day 2**: æ·»åŠ æ–¹æ¡ˆ 2ï¼ˆå®šæœŸ checkpointï¼‰
3. **Day 3**: æµ‹è¯•éªŒè¯ 24 å°æ—¶ç¨³å®šæ€§

**é¢„æœŸæ•ˆæœ**:
- **WAL æ–‡ä»¶**: <1 MB
- **WAL/DB æ¯”ä¾‹**: <5%
- **æ€§èƒ½å½±å“**: æ— æ˜¾è‘—å˜åŒ–

---

## ç“¶é¢ˆ 3: DoH ä¸Šæ¸¸å»¶è¿Ÿï¼ˆMediumï¼‰

### é—®é¢˜æè¿°

ä½¿ç”¨ DNS over HTTPS (DoH) ä¸Šæ¸¸ï¼ˆCloudflareã€Googleï¼‰å¯¼è‡´æŸ¥è¯¢å»¶è¿Ÿå¢åŠ ã€‚

### æµ‹è¯•æ•°æ®

**é¦–æ¬¡æµ‹è¯•**:
- **å¹³å‡å»¶è¿Ÿ**: 629ms
- **å¯èƒ½åŸå› **: DNS ç¼“å­˜å†·å¯åŠ¨ã€ç½‘ç»œæŠ–åŠ¨

**åç»­æµ‹è¯•**:
- **P50 å»¶è¿Ÿ**: 1-3 msï¼ˆç¼“å­˜å‘½ä¸­ï¼‰
- **P95 å»¶è¿Ÿ**: 4-8 ms

### æ ¹æœ¬åŸå› åˆ†æ

#### DoH vs UDP/TCP DNS

| åè®® | å»¶è¿Ÿ | å®‰å…¨æ€§ | å…¼å®¹æ€§ |
|------|------|--------|--------|
| UDP DNS | <1ms | ä½ | é«˜ |
| TCP DNS | 1-2ms | ä½ | é«˜ |
| DoH | 10-50ms | é«˜ | ä¸­ |

**DoH é¢å¤–å¼€é”€**:
1. TLS æ¡æ‰‹
2. HTTP è¯·æ±‚/å“åº”
3. ç½‘ç»œå¾€è¿”æ—¶é—´

**å½“å‰é…ç½®**:
```rust
// src/dns/resolver.rs
let resolver = TokioAsyncResolver::tokio(ResolverConfig::cloudflare(), opts);
// Cloudflare é»˜è®¤ä½¿ç”¨ DoH: https://1.1.1.1/dns-query
```

### æ€§èƒ½å½±å“è¯„ä¼°

**å¯¹ç”¨æˆ·çš„å½±å“**:
- **ç¼“å­˜å‘½ä¸­**: 1-3 msï¼ˆå¯æ¥å—ï¼‰
- **ç¼“å­˜æœªå‘½ä¸­**: 10-50msï¼ˆDoH å¼€é”€ï¼‰
- **DNSSEC éªŒè¯**: é¢å¤–å»¶è¿Ÿ

**ä¸ç“¶é¢ˆ 1 çš„å…³ç³»**:
- ä¸æ˜¯ä¸»è¦ç“¶é¢ˆï¼ˆDNS ID é—®é¢˜æ›´ä¸¥é‡ï¼‰
- ä¿®å¤ç“¶é¢ˆ 1 åï¼Œæ­¤é—®é¢˜çš„å½±å“ä¼šæ›´æ˜æ˜¾

### ä¿®å¤æ–¹æ¡ˆ

#### æ–¹æ¡ˆ 1: æä¾›ä¸Šæ¸¸é…ç½®é€‰é¡¹

```rust
// Config æ·»åŠ  upstream_protocol å­—æ®µ
#[derive(Debug, Clone, Deserialize)]
pub struct Config {
    pub dns: DnsConfig,
    // ...
}

#[derive(Debug, Clone, Deserialize)]
pub struct DnsConfig {
    pub port: u16,
    pub bind: String,
    pub upstreams: Vec<String>,
    #[serde(default = "default_upstream_protocol")]
    pub upstream_protocol: String,  // "doh" | "udp" | "tcp"
}

fn default_upstream_protocol() -> String {
    "doh".to_string()
}
```

#### æ–¹æ¡ˆ 2: æ”¯æŒä¸Šæ¸¸è´Ÿè½½å‡è¡¡

```rust
// DnsResolver æ·»åŠ å¤šä¸Šæ¸¸æ”¯æŒ
pub struct DnsResolver {
    resolvers: Vec<TokioAsyncResolver>,  // å¤šä¸ªä¸Šæ¸¸
    current: AtomicUsize,  // Round-robin index
}

// è½®è¯¢ä¸Šæ¸¸
async fn resolve(&self, domain: &str, qtype: RecordType, request: &Message) -> Result<(Vec<u8>, Option<u32>)> {
    let idx = self.current.fetch_add(1, Ordering::SeqCst) % self.resolvers.len();
    self.resolvers[idx].lookup(domain, qtype).await
}
```

#### æ–¹æ¡ˆ 3: æ·»åŠ è¶…æ—¶å’Œé‡è¯•é…ç½®

```rust
let mut opts = ResolverOpts::default();
opts.cache_size = 0;
opts.use_hosts_file = false;
opts.validate = true;
opts.timeout = Duration::from_secs(5);  // è¶…æ—¶é…ç½®
opts.attempts = 3;  // é‡è¯•æ¬¡æ•°
```

### ä¿®å¤ä¼˜å…ˆçº§: **P2ï¼ˆä¸­ï¼‰**

**åŸå› **:
- ä¸æ˜¯é˜»å¡é—®é¢˜ï¼ˆDNS ID æ›´ä¸¥é‡ï¼‰
- å¯é€šè¿‡é…ç½®ç¼“è§£
- ç¼“å­˜å‘½ä¸­ç‡é«˜æ—¶å½±å“å°

**ä¿®å¤è®¡åˆ’**:
1. **Day 1**: å®ç°æ–¹æ¡ˆ 1ï¼ˆä¸Šæ¸¸åè®®é…ç½®ï¼‰
2. **Day 2**: æµ‹è¯•éªŒè¯ UDP ä¸Šæ¸¸æ€§èƒ½

**é¢„æœŸæ•ˆæœ**:
- **UDP ä¸Šæ¸¸å»¶è¿Ÿ**: <1msï¼ˆç¼“å­˜æœªå‘½ä¸­ï¼‰
- **DoH å»¶è¿Ÿ**: ä¿æŒç°çŠ¶
- **ç”¨æˆ·å¯é…ç½®**: æ ¹æ®éœ€æ±‚é€‰æ‹©

---

## ç“¶é¢ˆ 4: Metrics ç«¯ç‚¹è®¤è¯ï¼ˆLowï¼‰

### é—®é¢˜æè¿°

`/metrics` ç«¯ç‚¹éœ€è¦è®¤è¯ï¼Œå¯¼è‡´ Prometheus æ— æ³•ç›´æ¥æŠ“å–æŒ‡æ ‡ã€‚

### æµ‹è¯•æ•°æ®

```bash
$ curl http://127.0.0.1:8080/metrics
{"error":"Authentication failed"}
```

### æ ¹æœ¬åŸå› åˆ†æ

#### Prometheus æœ€ä½³å®è·µ

**å®˜æ–¹å»ºè®®**:
- `/metrics` ç«¯ç‚¹åº”**æ— éœ€è®¤è¯**
- é€šè¿‡é˜²ç«å¢™æˆ–åå‘ä»£ç†æ§åˆ¶è®¿é—®
- ä½¿ç”¨ IP ç™½åå•æˆ–æœåŠ¡ç½‘æ ¼

**å½“å‰å®ç°**ï¼ˆæ¨æµ‹ï¼‰:
```rust
// src/api/handlers/metrics.rs
pub async fn metrics(
    State(state): State<Arc<AppState>>,
    auth: AuthUser,  // â† éœ€è¦è®¤è¯
) -> Result<String> {
    // ...
}
```

### å½±å“è¯„ä¼°

**å½“å‰å½±å“**:
- Prometheus æ— æ³•ç›´æ¥æŠ“å–
- éœ€è¦é…ç½®è®¤è¯ï¼ˆBearer Tokenï¼‰
- å¢åŠ ç›‘æ§å¤æ‚åº¦

**æœªæ¥å½±å“**:
- é›†æˆå…¶ä»–ç›‘æ§å·¥å…·å›°éš¾
- ä¸ç¬¦åˆè¡Œä¸šæ ‡å‡†

### ä¿®å¤æ–¹æ¡ˆ

#### æ–¹æ¡ˆ 1: æ·»åŠ é…ç½®é€‰é¡¹

```rust
// Config æ·»åŠ  metrics_auth_required å­—æ®µ
#[derive(Debug, Clone, Deserialize)]
pub struct Config {
    pub api: ApiConfig,
    // ...
}

#[derive(Debug, Clone, Deserialize)]
pub struct ApiConfig {
    pub port: u16,
    pub bind: String,
    #[serde(default)]
    pub cors_allowed_origins: Option<String>,
    #[serde(default = "default_metrics_auth")]
    pub metrics_auth_required: bool,
}

fn default_metrics_auth() -> bool {
    false  // é»˜è®¤æ— éœ€è®¤è¯
}
```

**è·¯ç”±é…ç½®**:
```rust
// æ ¹æ®é…ç½®é€‰æ‹©è®¤è¯æ–¹å¼
if config.api.metrics_auth_required {
    router.route("/metrics", get(metrics_with_auth))
} else {
    router.route("/metrics", get(metrics_without_auth))
}
```

#### æ–¹æ¡ˆ 2: IP ç™½åå•

```rust
#[derive(Debug, Clone, Deserialize)]
pub struct ApiConfig {
    // ...
    #[serde(default)]
    pub metrics_allowed_ips: Vec<String>,  // ["127.0.0.1", "10.0.0.0/8"]
}

pub async fn metrics_without_auth(
    State(state): State<Arc<AppState>>,
    ConnectInfo(addr): ConnectInfo<SocketAddr>,
) -> Result<String> {
    if !is_allowed_ip(&addr.ip(), &config.api.metrics_allowed_ips) {
        return Err(AppError::Unauthorized);
    }
    // ...
}

fn is_allowed_ip(ip: &IpAddr, allowed: &[String]) -> bool {
    allowed.iter().any(|pattern| {
        if let Ok(prefix) = pattern.parse::<IpNet>() {
            prefix.contains(*ip)
        } else if let Ok(allowed_ip) = pattern.parse::<IpAddr>() {
            allowed_ip == *ip
        } else {
            false
        }
    })
}
```

### ä¿®å¤ä¼˜å…ˆçº§: **P3ï¼ˆä½ï¼‰**

**åŸå› **:
- ä¸é˜»å¡åŠŸèƒ½
- å¯é€šè¿‡ä¸´æ—¶æ–¹æ¡ˆç»•è¿‡
- ä¸å½±å“æ€§èƒ½

**ä¿®å¤è®¡åˆ’**:
1. **Day 1**: å®ç°æ–¹æ¡ˆ 1ï¼ˆé…ç½®é€‰é¡¹ï¼‰
2. **Day 2**: æ›´æ–°æ–‡æ¡£

**é¢„æœŸæ•ˆæœ**:
- **Prometheus é›†æˆ**: æ— éœ€è®¤è¯
- **å¯é€‰è®¤è¯**: ç”Ÿäº§ç¯å¢ƒå¯å¯ç”¨
- **å‘åå…¼å®¹**: ä¸å½±å“ç°æœ‰éƒ¨ç½²

---

## ä¿®å¤ä¼˜å…ˆçº§æ’åº

åŸºäºæ€§èƒ½å½±å“å’Œä¿®å¤éš¾åº¦ï¼Œæ¨èçš„ä¿®å¤é¡ºåºï¼š

### Phase 1: ç´§æ€¥ä¿®å¤ï¼ˆ1-2 å¤©ï¼‰

| ä¼˜å…ˆçº§ | ç“¶é¢ˆ | é¢„è®¡å·¥ä½œé‡ | æ€§èƒ½æå‡ |
|--------|------|------------|----------|
| P0 | DNS ID ä¸åŒ¹é… | 1-2 å¤© | **97-98%** |
| P1 | WAL æ–‡ä»¶å¢é•¿ | 0.5 å¤© | æ½œåœ¨ 10-20% |

### Phase 2: ä¼˜åŒ–æ”¹è¿›ï¼ˆ1 å¤©ï¼‰

| ä¼˜å…ˆçº§ | ç“¶é¢ˆ | é¢„è®¡å·¥ä½œé‡ | æ€§èƒ½æå‡ |
|--------|------|------------|----------|
| P2 | DoH ä¸Šæ¸¸å»¶è¿Ÿ | 0.5 å¤© | 1-3 ms |

### Phase 3: ç›‘æ§å¢å¼ºï¼ˆ0.25 å¤©ï¼‰

| ä¼˜å…ˆçº§ | ç“¶é¢ˆ | é¢„è®¡å·¥ä½œé‡ | ç”¨æˆ·ä½“éªŒæå‡ |
|--------|------|------------|------------|
| P3 | Metrics è®¤è¯ | 0.25 å¤© | ç›‘æ§é›†æˆç®€åŒ– |

**æ€»ä¿®å¤æ—¶é—´**: 2.75-4.25 å¤©

---

## éªŒè¯è®¡åˆ’

### P0 ä¿®å¤éªŒè¯

**æµ‹è¯•æ–¹æ³•**:
1. å¯ç”¨ DEBUG æ—¥å¿—ï¼Œè®°å½• DNS ID
2. é‡æ–°æ‰§è¡Œ QPS æµ‹è¯•ï¼ˆ100, 500, 1000, 2000ï¼‰
3. éªŒè¯å®é™… QPS ä¸ç›®æ ‡ QPS åŒ¹é…
4. éªŒè¯é”™è¯¯ç‡ <1%

**é€šè¿‡æ ‡å‡†**:
- âœ… å®é™… QPS â‰¥ 90% ç›®æ ‡ QPS
- âœ… é”™è¯¯ç‡ <1%
- âœ… æ—  "Unexpected IDs" é”™è¯¯

### P1 ä¿®å¤éªŒè¯

**æµ‹è¯•æ–¹æ³•**:
1. æ‰§è¡Œ 1 å°æ—¶ç¨³å®šæ€§æµ‹è¯•ï¼ˆ1000 QPSï¼‰
2. ç›‘æ§ WAL æ–‡ä»¶å¤§å°
3. éªŒè¯ WAL/DB æ¯”ä¾‹ <10%

**é€šè¿‡æ ‡å‡†**:
- âœ… WAL æ–‡ä»¶ <1 MB
- âœ… WAL/DB æ¯”ä¾‹ <10%
- âœ… æ—  checkpoint é˜»å¡

### P2 ä¿®å¤éªŒè¯

**æµ‹è¯•æ–¹æ³•**:
1. åˆ‡æ¢åˆ° UDP ä¸Šæ¸¸
2. æµ‹è¯• 1000 QPS
3. å¯¹æ¯” P50/P95 å»¶è¿Ÿ

**é€šè¿‡æ ‡å‡†**:
- âœ… P50 å»¶è¿Ÿ <1ms
- âœ… P95 å»¶è¿Ÿ <10ms

### P3 ä¿®å¤éªŒè¯

**æµ‹è¯•æ–¹æ³•**:
1. é…ç½® `metrics_auth_required = false`
2. ä½¿ç”¨ Prometheus æŠ“å–æŒ‡æ ‡
3. éªŒè¯æ— éœ€è®¤è¯

**é€šè¿‡æ ‡å‡†**:
- âœ… Prometheus æˆåŠŸæŠ“å–
- âœ… æ— è®¤è¯é”™è¯¯

---

## é£é™©è¯„ä¼°

### ä¿®å¤é£é™©

| é£é™© | å½±å“ | æ¦‚ç‡ | ç¼“è§£æªæ–½ |
|------|------|------|----------|
| DNS ID ä¿®å¤å¼•å…¥æ–° bug | High | Medium | å……åˆ†æµ‹è¯•ï¼Œä¿ç•™å›é€€æ–¹æ¡ˆ |
| WAL checkpoint å½±å“æ€§èƒ½ | Medium | Low | å°æ‰¹é‡æµ‹è¯•ï¼Œé€æ­¥æ¨å¹¿ |
| æ›´æ¢ DNS åº“ä¸å…¼å®¹ | High | Low | å…ˆåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯ |

### å›é€€è®¡åˆ’

**P0 ä¿®å¤å¤±è´¥**:
- å°è¯•æ–¹æ¡ˆ 2ï¼ˆTCP é•¿è¿æ¥ï¼‰
- è€ƒè™‘æ›´æ¢åˆ° `trust-dns`

**P1 ä¿®å¤å¤±è´¥**:
- æ¢å¤åŸæœ‰é…ç½®
- ä¼˜åŒ–æ‰¹é‡å†™å…¥å‚æ•°

**P2 ä¿®å¤å¤±è´¥**:
- ä¿ç•™ DoH ä½œä¸ºé»˜è®¤
- ç”¨æˆ·å¯æ‰‹åŠ¨åˆ‡æ¢åˆ° UDP

**P3 ä¿®å¤å¤±è´¥**:
- ä½¿ç”¨åå‘ä»£ç†ï¼ˆNginxï¼‰å¤„ç†è®¤è¯
- æˆ–ç»§ç»­ä½¿ç”¨ Bearer Token

---

## é•¿æœŸå»ºè®®

### æ¶æ„ä¼˜åŒ–

1. **è¿ç§»åˆ°åˆ†å¸ƒå¼ DNS**
   - ä½¿ç”¨ etcd æˆ– Consul å­˜å‚¨é…ç½®
   - æ”¯æŒå¤šå®ä¾‹éƒ¨ç½²

2. **å®ç° DNS over QUIC (DoQ)**
   - é™ä½å»¶è¿Ÿ
   - æé«˜å®‰å…¨æ€§

3. **æ·»åŠ  GraphQL API**
   - çµæ´»æŸ¥è¯¢
   - å‡å°‘ HTTP è¯·æ±‚æ¬¡æ•°

### å¯è§‚æµ‹æ€§å¢å¼º

1. **é›†æˆ OpenTelemetry**
   - åˆ†å¸ƒå¼è¿½è¸ª
   - ç»Ÿä¸€ç›‘æ§

2. **æ·»åŠ æ€§èƒ½å‰–æ**
   - Flame graph
   - ç“¶é¢ˆå¯è§†åŒ–

3. **å®æ—¶å‘Šè­¦**
   - Prometheus AlertManager
   - PagerDuty é›†æˆ

---

## é™„å½•

### A. ç›¸å…³ä»£ç æ–‡ä»¶

| ç“¶é¢ˆ | ç›¸å…³æ–‡ä»¶ |
|------|----------|
| DNS ID ä¸åŒ¹é… | `src/dns/handler.rs`, `src/dns/resolver.rs` |
| WAL æ–‡ä»¶å¢é•¿ | `src/db/query_log_writer.rs`, `src/db/mod.rs` |
| DoH ä¸Šæ¸¸å»¶è¿Ÿ | `src/dns/resolver.rs`, `src/config.rs` |
| Metrics è®¤è¯ | `src/api/handlers/metrics.rs`, `src/api/mod.rs` |

### B. å‚è€ƒæ–‡æ¡£

- æ€§èƒ½æµ‹è¯•æ–¹æ¡ˆ: `docs/qa/performance-load-test-plan.md`
- æ€§èƒ½åŸºçº¿æŠ¥å‘Š: `docs/qa/performance-baseline.md`
- å¿«é€Ÿå¯åŠ¨æŒ‡å—: `tests/loadtest/README.md`

### C. æµ‹è¯•å‘½ä»¤

```bash
# DNS QPS æµ‹è¯•
dnsperf -s 127.0.0.1 -p 15353 -d domains.txt -l 30 -q 1000

# WAL æ–‡ä»¶ç›‘æ§
watch -n 10 'ls -lh /tmp/ent-dns-loadtest.db-wal'

# Metrics éªŒè¯
curl http://127.0.0.1:8080/metrics
```

---

## ç»“è®º

æœ¬æŠ¥å‘Šåˆ†æäº† Ent-DNS çš„ 4 ä¸ªä¸»è¦æ€§èƒ½ç“¶é¢ˆï¼Œå…¶ä¸­ **DNS ID ä¸åŒ¹é…æ˜¯æœ€ä¸¥é‡çš„ P0 çº§åˆ«é—®é¢˜**ï¼Œéœ€è¦ç´§æ€¥ä¿®å¤ã€‚å…¶ä»–é—®é¢˜ï¼ˆWAL å¢é•¿ã€DoH å»¶è¿Ÿã€Metrics è®¤è¯ï¼‰æŒ‰ç…§ P1-P3 ä¼˜å…ˆçº§é€æ­¥ä¿®å¤ã€‚

å»ºè®®æŒ‰ç…§ä»¥ä¸‹é¡ºåºæ‰§è¡Œä¿®å¤ï¼š
1. **P0**: ä¿®å¤ DNS ID ä¸åŒ¹é…ï¼ˆ1-2 å¤©ï¼‰
2. **P1**: ä¼˜åŒ– WAL checkpointï¼ˆ0.5 å¤©ï¼‰
3. **P2**: æä¾›ä¸Šæ¸¸é…ç½®é€‰é¡¹ï¼ˆ0.5 å¤©ï¼‰
4. **P3**: Metrics ç«¯ç‚¹å¯é€‰è®¤è¯ï¼ˆ0.25 å¤©ï¼‰

ä¿®å¤å®Œæˆåï¼Œé‡æ–°æ‰§è¡Œæ€§èƒ½æµ‹è¯•éªŒè¯æ•ˆæœï¼Œç¡®è®¤ QPS æå‡è‡³ 100-2000ï¼Œé”™è¯¯ç‡é™è‡³ <1%ã€‚

**å½“å‰çŠ¶æ€**: **ä¸å»ºè®®ä¸Šçº¿ç”Ÿäº§ç¯å¢ƒ**

**ä¸‹ä¸€æ­¥**: ä¿®å¤ P0 é—®é¢˜åï¼Œé‡æ–°æ‰§è¡Œæ€§èƒ½æµ‹è¯•ã€‚

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2026-02-20 11:10 +04:00
**QA è´Ÿè´£äºº**: James Bach
**å®¡æ ¸çŠ¶æ€**: å¾…å®¡æ ¸
