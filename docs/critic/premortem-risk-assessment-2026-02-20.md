# Ent-DNS Pre-Mortem 风险评估报告

**评估人**: Critic Charlie Munger
**评估日期**: 2026-02-20
**评估方法**: Pre-Mortem 分析（想象失败后逆向推导失败模式）

---

## 执行摘要

通过 Pre-Mortem 分析，识别出 Ent-DNS 潜在的 12 个失败模式，按风险等级分类：

- **Critical（2 个）**：性能瓶颈导致服务崩溃、重大安全漏洞泄露数据
- **High（5 个）**：DoH/DoT 缺失导致用户流失、竞品快速追赶、用户体验差导致低转化
- **Medium（4 个）**：技术债务积累、社区维护成本高、商业化失败

**总体风险评级**：**中等偏高**（风险控制能力 7/10）

**关键预防措施**：
1. 发布前完成 DoH/DoT 支持（P1）
2. 建立性能监控和压力测试（P1）
3. 定期安全审计（每季度）
4. 建立 onboarding 引导（P1）

---

## 一、Pre-Mortem 分析方法论

**假设场景**：Ent-DNS 发布 12 个月后失败，用户流失到 0，项目终止。

**分析步骤**：
1. 头脑风暴失败原因（8-12 个失败模式）
2. 评估失败概率和影响（风险矩阵）
3. 制定预防措施（每个失败模式）
4. 制定应急计划（失败发生后的应对）

---

## 二、失败模式分析

### 2.1 Critical 级别

#### F-1: 性能瓶颈导致服务崩溃

**失败场景**：
- 某企业客户部署 Ent-DNS 后，查询量激增（10,000 QPS）
- SQLite 数据库写入瓶颈，查询延迟飙升
- DNS 查询超时，影响整个内网办公
- 客户投诉，公开差评，用户流失

**失败概率**: **高（70%）**
**失败影响**: **极高（9/10）**

**根本原因**：
- SQLite 单文件数据库不支持高并发写入
- 查询日志批量写入 channel 满载后阻塞
- 未进行压力测试，性能瓶颈未提前发现

**预防措施（P1 优先级）**：
1. **性能测试**（1 周）
   - 使用 `dnsperf` 压力测试，验证 10,000 QPS 目标
   - 监控数据库 I/O 延迟、内存占用、CPU 使用率

2. **性能监控**（3 天）
   - Prometheus 指标：`dns_query_latency_ms`、`db_write_latency_ms`
   - 告警规则：P99 延迟 > 100ms 触发告警

3. **架构优化**（P2 优先级）
   - 查询日志迁移到 ClickHouse/TimescaleDB
   - 数据库读写分离

**应急计划**：
- 立即回滚到稳定版本
- 临时限制 QPS（使用 `tower-governor`）
- 紧急迁移到 PostgreSQL

---

#### F-2: 重大安全漏洞泄露数据

**失败场景**：
- 攻击者发现 JWT 验证逻辑漏洞，可伪造管理员 token
- 攻击者获取 admin 权限，下载查询日志（含客户端 IP）
- 客户端 IP 泄露，客户投诉法律风险
- GitHub issue 炸锅，社区信任崩塌

**失败概率**: **中（40%）**
**失败影响**: **极高（10/10）**

**根本原因**：
- JWT 验证逻辑错误（例如：未校验过期时间）
- 审计日志缺失，无法追溯攻击来源
- 未进行第三方安全审计

**预防措施（P1 优先级）**：
1. **安全审计**（1 周）
   - 引入第三方安全审计公司（例如：Trail of Bits）
   - 覆盖代码审计、渗透测试、依赖漏洞扫描

2. **审计日志增强**（3 天）
   - 记录所有 API 调用（Who、When、What、Result）
   - 审计日志不可删除/修改（append-only）

3. **依赖漏洞扫描**（3 天）
   - CI/CD 集成 `cargo-audit`、`cargo-deny`
   - 自动检测 CVE 漏洞

**应急计划**：
- 立即发布安全补丁（0.1.x-hotfix）
- 通知所有用户紧急升级
- GitHub issue 公开透明说明

---

### 2.2 High 级别

#### F-3: DoH/DoT 缺失导致用户流失

**失败场景**：
- 现代浏览器（Chrome/Firefox）默认使用 DoH
- Ent-DNS 不支持 DoH，浏览器绕过本机 DNS
- 用户无法拦截广告，抱怨"产品无效"
- 用户迁移到 AdGuard Home，差评如潮

**失败概率**: **极高（90%）**
**失败影响**: **高（8/10）**

**根本原因**：
- 技术栈依赖 hickory-resolver，已支持 DoH/DoT，但未实现
- 优先级排序错误，认为 DoH/DoT 不是核心功能

**预防措施（P1 优先级）**：
1. **DoH 端点实现**（1 周）
   - `/dns-query` GET 端点（RFC 8484）
   - Base64 编码 DNS 查询

2. **DoT 端点实现**（1 周）
   - TCP 853 端口
   - TLS 证书自动续期（Let's Encrypt）

3. **测试验证**（3 天）
   - Chrome/浏览器测试 DoH 连接
   - 客户端测试 DoT 连接

**应急计划**：
- 发布说明：DoH/DoT 正在开发中（v1.1）
- 提供临时方案：通过 Nginx 反向代理 DoH

---

#### F-4: 竞品快速追赶

**失败场景**：
- AdGuard Home 发布企业版，添加 RBAC 和审计日志
- AdGuard Home 品牌认知度高，快速抢占市场
- Ent-DNS 差异化优势消失，用户流失

**失败概率**: **中（50%）**
**失败影响**: **高（7/10）**

**根本原因**：
- 技术壁垒低（RBAC + 审计日志容易实现）
- 社区规模小，难以抗衡 AdGuard Home

**预防措施（P2 优先级）**：
1. **快速迭代**（持续）
   - 每 2 周发布一个版本
   - 抢占功能先机（例如：客户端分组、高级过滤规则）

2. **社区建设**（持续）
   - GitHub 星标目标：1K
   - Discord/Slack 社区，增强用户粘性

3. **差异化定位**（P1 优先级）
   - 强调性能优势（Rust vs Go）
   - 强调数据主权（自托管 vs SaaS）

**应急计划**：
- 转型为纯工具项目（放弃商业化）
- 专注性能优化，成为高性能 DNS 引擎

---

#### F-5: 用户体验差导致低转化

**失败场景**：
- 新用户登录后不知道下一步做什么
- 规则语法错误，提示不明确
- 用户挫败感强烈，放弃使用
- 付费转化率 < 1%

**失败概率**: **高（70%）**
**失败影响**: **中（6/10）**

**根本原因**：
- 无 onboarding 引导流程
- 错误提示过于笼统（"创建失败: 未知错误"）
- 未进行可用性测试

**预防措施（P1 优先级）**：
1. **Onboarding 引导**（3 天）
   - 3 步引导：添加过滤列表 → 配置客户端 → 查看日志
   - 首次登录检测 `first_login` 标志

2. **规则语法验证**（2 天）
   - 实时验证规则语法
   - 友好的错误提示

3. **可用性测试**（1 周）
   - 邀请 10 位用户进行测试
   - 记录任务完成率、完成时间

**应急计划**：
- 紧急添加帮助中心（文档 + 视频教程）
- 社区 Discord 提供实时支持

---

#### F-6: 技术债务积累

**失败场景**：
- 快速迭代导致代码质量下降
- `unwrap()`、`.expect()` 遍布代码库
- 生产环境 panic，服务频繁崩溃
- 开发维护成本高，开发者流失

**失败概率**: **中（50%）**
**失败影响**: **高（8/10）**

**根本原因**：
- 过度追求速度，忽视代码质量
- 缺少代码审查流程
- 缺少自动化测试

**预防措施（P2 优先级）**：
1. **代码审查**（持续）
   - 所有 PR 必须经过 1 位 reviewer 审查
   - 检查：`.unwrap()`、`.expect()`、错误处理

2. **自动化测试**（P2 优先级）
   - 单元测试覆盖率 ≥ 80%
   - 集成测试覆盖所有 API 端点

3. **重构周**（每季度）
   - 1 周专门用于重构技术债务
   - 例如：替换 unwrap()、优化数据库查询

**应急计划**：
- 发布维护版本（0.2.x），仅修复 bug，不加新功能
- 停止新功能开发，全力重构

---

#### F-7: 社区维护成本高

**失败场景**：
- GitHub issue 炸锅，大量 bug 报告
- Discord 社区提问无人回答
- 开发者被社区压力压垮，退出项目
- 项目无人维护，社区流失

**失败概率**: **中（40%）**
**失败影响**: **中（6/10）**

**根本原因**：
- 项目发布过早，质量问题多
- 社区规模增长过快，开发者不足
- 未建立社区治理机制

**预防措施（P2 优先级）**：
1. **社区治理**（3 天）
   - 建立 Code of Conduct（行为准则）
   - 招募社区维护者（从活跃贡献者中）

2. **自动化支持**（1 周）
   - FAQ 机器人（自动回复常见问题）
   - Issue 模板（强制用户填写问题细节）

3. **文档完善**（1 周）
   - 部署指南、API 文档、故障排查
   - 视频教程（YouTube/B 站）

**应急计划**：
- 暂停 issue 接收，专注修复 bug
- 招募更多维护者（社区招募）

---

### 2.3 Medium 级别

#### F-8: 商业化失败

**失败场景**：
- 付费转化率 < 1%
- 月收入不足以覆盖开发成本
- 开发者退出，项目终止

**失败概率**: **中（40%）**
**失败影响**: **中（6/10）**

**根本原因**：
- 产品价值未传递清楚
- 定价过高或过低
- 目标用户错误（家庭用户而非企业用户）

**预防措施**（见 CFO 报告）：
- 优化 onboarding，提升用户留存
- A/B 测试定价（$19/月 vs $29/月 vs $39/月）
- 聚焦中小企业（家庭用户免费）

#### F-9: SQLite 单点瓶颈

**失败场景**：
- 查询日志积累到 1000 万条，SQLite 文件膨胀
- 查询日志导出超时
- 数据库锁竞争，DNS 延迟飙升

**失败概率**: **中（40%）**
**失败影响**: **中（5/10）**

**预防措施**（P2 优先级）：
- 查询日志自动清理（已实现，保留 30 天）
- 迁移到 ClickHouse/TimescaleDB（P2）

#### F-10: 依赖库废弃

**失败场景**：
- hickory-resolver 停止维护，CVE 漏洞未修复
-被迫迁移到其他 DNS 库，工作量大

**失败概率**: **低（20%）**
**失败影响**: **中（5/10）**

**预防措施**：
- 锁定依赖版本至 0.24
- 关注 hickory-resolver 社区动态
- 预备迁移方案（trust-dner）

#### F-11: 法规合规风险

**失败场景**：
- GDPR/CCPA 要求查询日志匿名化，未实现
- 企业客户因合规问题放弃使用

**失败概率**: **低（20%）**
**失败影响**: **中（5/10）**

**预防措施**（P2 优先级）：
- 查询日志匿名化选项（hash 客户端 IP）
- 数据导出功能（GDPR 数据主体权利）
- 隐私政策声明

#### F-12: 多租户架构缺失

**失败场景**：
- 企业客户要求多租户隔离，无法满足
- 客户流失到 Cloudflare for Teams

**失败概率**: **低（20%）**
**失败影响**: **中（4/10）**

**预防措施**（P3 优先级）：
- 企业版功能：租户隔离
- 数据库表添加 `tenant_id` 字段

---

## 三、风险矩阵

| 失败模式 | 概率 | 影响 | 风险等级 | 优先级 |
|---------|------|------|---------|--------|
| F-1: 性能瓶颈 | 高 | 极高 | **Critical** | P1 |
| F-2: 安全漏洞 | 中 | 极高 | **Critical** | P1 |
| F-3: DoH/DoT 缺失 | 极高 | 高 | **High** | P1 |
| F-4: 竞品追赶 | 中 | 高 | **High** | P2 |
| F-5: 用户体验差 | 高 | 中 | **High** | P1 |
| F-6: 技术债务 | 中 | 高 | **High** | P2 |
| F-7: 社区维护 | 中 | 中 | **High** | P2 |
| F-8: 商业化失败 | 中 | 中 | **Medium** | P2 |
| F-9: SQLite 瓶颈 | 中 | 中 | **Medium** | P2 |
| F-10: 依赖废弃 | 低 | 中 | **Medium** | P3 |
| F-11: 法规合规 | 低 | 中 | **Medium** | P3 |
| F-12: 多租户缺失 | 低 | 中 | **Medium** | P3 |

---

## 四、总体风险评估

| 维度 | 评分 | 说明 |
|------|------|------|
| **技术风险** | 7/10 | 性能瓶颈、DoH/DoT 缺失、技术债务 |
| **安全风险** | 6/10 | 15 个安全问题已修复，需第三方审计 |
| **市场风险** | 7/10 | 竞品追赶、用户体验差 |
| **商业风险** | 6/10 | 商业化失败概率中等，开源驱动获客成本低 |
| **运营风险** | 7/10 | 社区维护成本高、依赖社区贡献 |
| **总体风险评级** | **6.6/10** | **中等偏高** |

**风险控制能力**：**7/10**（有预防措施，但执行依赖团队）

---

## 五、结论与建议

### 5.1 发布前必做项（P1）

| 失败模式 | 预防措施 | 工作量 |
|---------|---------|--------|
| F-1: 性能瓶颈 | 压力测试 + 性能监控 | 1 周 |
| F-2: 安全漏洞 | 第三方安全审计 | 1 周 |
| F-3: DoH/DoT 缺失 | 实现 DoH/DoT 端点 | 2 周 |
| F-5: 用户体验差 | Onboarding 引导 + 规则语法验证 | 5 天 |

**总计**：4 周（1 个月）

### 5.2 近期计划（P2）

| 失败模式 | 预防措施 | 工作量 |
|---------|---------|--------|
| F-4: 竞品追赶 | 快速迭代 + 社区建设 | 持续 |
| F-6: 技术债务 | 代码审查 + 自动化测试 | 持续 |
| F-7: 社区维护 | 社区治理 + 自动化支持 | 2 周 |
| F-8: 商业化失败 | 优化 onboarding + A/B 测试定价 | 2 周 |
| F-9: SQLite 瓶颈 | 迁移到 ClickHouse/TimescaleDB | 2 周 |

### 5.3 长期规划（P3）

| 失败模式 | 预防措施 | 工作量 |
|---------|---------|--------|
| F-10: 依赖废弃 | 预备迁移方案 | 1 周 |
| F-11: 法规合规 | 查询日志匿名化 | 1 周 |
| F-12: 多租户缺失 | 企业版功能 | 3 周 |

---

**签名**: Charlie Munger, Critic
**日期**: 2026-02-20
